<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Feed | Social App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .post-media-container {
            max-width: 100%;
            max-height: 500px;
            overflow: hidden;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .post-media-container img, .post-media-container iframe {
            width: 100%;
            height: auto;
            max-height: 500px;
            object-fit: contain;
        }
        .heart-icon {
            cursor: pointer;
            transition: color 0.1s ease-in-out, transform 0.1s ease-in-out;
        }
        .heart-icon:hover {
            transform: scale(1.1);
        }
        .liked {
            color: #ef4444; /* Red 500 */
        }
        .loader {
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-2xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">
                    Public Feed ðŸŒŽ
                </h1>
                <p class="mt-2 text-lg text-gray-500">
                    See the latest posts shared by creators.
                </p>
            </div>
            <a href="studio.html" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm border border-indigo-600 px-3 py-1 rounded-full">
                Go to Studio &rarr;
            </a>
        </header>

        <div id="loading" class="text-center py-10">
            <div class="loader w-8 h-8 border-4 border-gray-200 border-solid rounded-full inline-block"></div>
            <p class="mt-2 text-gray-600">Loading posts...</p>
        </div>

        <div id="postsContainer" class="space-y-8">
            </div>

        <div id="error" class="hidden text-center py-10 text-red-600">
            <p>Failed to load posts. Check the Apps Script URL and network connection.</p>
        </div>
    </div>

    <script>
        // REPLACE THIS WITH YOUR DEPLOYED GOOGLE APPS SCRIPT WEB APP URL
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyO4xG-nSsA2sxoyVIwnd6F7iTEpOm6LwZdWrP-QUL0cFXCdntkc_AIbBihVMmaSKQi/exec"; 
        const postsContainer = document.getElementById('postsContainer');
        const loadingIndicator = document.getElementById('loading');
        const errorIndicator = document.getElementById('error');
        
        // --- Helper Functions ---

        /**
         * Renders a single post card.
         * @param {Object} post The post data object.
         */
        function renderPost(post) {
            const card = document.createElement('div');
            card.className = "bg-white shadow-lg rounded-xl overflow-hidden";
            card.setAttribute('data-post-id', post.postid);

            // Check localStorage to see if this post has been liked on this device
            const isLiked = localStorage.getItem(`liked_${post.postid}`) === 'true';
            const heartClass = isLiked ? 'liked' : 'text-gray-400';

            // Convert timestamp to readable format
            const date = new Date(post.timestamp);
            const timeAgo = formatTimeAgo(date);

            let mediaHTML = '';
            if (post.type === 'image') {
                mediaHTML = `<img src="${post.previewurl}" alt="${post.companyname}" loading="lazy" class="w-full">`;
            } else if (post.type === 'video') {
                mediaHTML = `
                    <iframe src="${post.previewurl}" width="100%" height="450" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
                `;
            }

            card.innerHTML = `
                <div class="post-media-container">${mediaHTML}</div>
                <div class="p-5">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">${post.companyname}</h2>
                    <p class="text-sm text-gray-500 mb-4">Posted ${timeAgo}</p>
                    <div class="flex items-center space-x-2">
                        <button class="like-btn" data-post-id="${post.postid}">
                            <svg class="heart-icon w-6 h-6 ${heartClass}" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                        </button>
                        <span class="like-count text-gray-600 font-semibold" data-post-id="${post.postid}">${post.likes}</span>
                    </div>
                </div>
            `;

            postsContainer.appendChild(card);
        }

        /**
         * Formats a date object into a 'time ago' string.
         */
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return "just now";
        }

        // --- Core Functions ---

        /**
         * Fetches all posts from the Apps Script backend.
         */
        async function loadPosts() {
            loadingIndicator.classList.remove('hidden');
            postsContainer.innerHTML = '';
            errorIndicator.classList.add('hidden');

            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const posts = await response.json();
                
                // Sort by Timestamp (newest first)
                posts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                posts.forEach(renderPost);
                
                // Attach event listeners after rendering
                attachLikeListeners();

            } catch (error) {
                console.error('Error loading posts:', error);
                errorIndicator.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        /**
         * Handles the click event for the like button.
         * @param {string} postId The ID of the post to like.
         * @param {HTMLElement} heartIcon The heart SVG element.
         * @param {HTMLElement} countElement The like count span element.
         */
        async function handleLike(postId, heartIcon, countElement) {
            const likedKey = `liked_${postId}`;
            
            if (localStorage.getItem(likedKey) === 'true') {
                alert("You've already liked this post!");
                return;
            }

            // Visually update immediately
            heartIcon.classList.add('liked');
            heartIcon.classList.remove('text-gray-400');
            let currentCount = parseInt(countElement.textContent);
            countElement.textContent = currentCount + 1;
            
            // Set local storage flag
            localStorage.setItem(likedKey, 'true');

            // Send update to the backend
            try {
                const response = await fetch(`${SCRIPT_URL}?action=like&postId=${postId}`);
                const result = await response.json();

                if (result.status === 'success') {
                    // Update count with server-confirmed value
                    countElement.textContent = result.newLikes;
                } else {
                    // Revert visual changes if server fails
                    alert('Server update failed, please refresh.');
                    heartIcon.classList.remove('liked');
                    heartIcon.classList.add('text-gray-400');
                    countElement.textContent = currentCount;
                    localStorage.removeItem(likedKey);
                }
            } catch (error) {
                console.error('Like network error:', error);
                alert('Network error while liking. Please try again.');
                // Revert visual changes on network failure
                heartIcon.classList.remove('liked');
                heartIcon.classList.add('text-gray-400');
                countElement.textContent = currentCount;
                localStorage.removeItem(likedKey);
            }
        }

        /**
         * Attaches event listeners to all like buttons.
         */
        function attachLikeListeners() {
            document.querySelectorAll('.like-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const postId = button.getAttribute('data-post-id');
                    const heartIcon = button.querySelector('.heart-icon');
                    const countElement = document.querySelector(`.like-count[data-post-id="${postId}"]`);
                    
                    if (postId && heartIcon && countElement) {
                        handleLike(postId, heartIcon, countElement);
                    }
                });
            });
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', loadPosts);
        
        // Refresh posts every 60 seconds
        setInterval(loadPosts, 60000); 

    </script>
</body>
</html>